# .github/workflows/cd.yml
name: CD - Deploy to Environment

on:
  workflow_run:
    workflows: ["CI - Build and Push Images"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get SHA and set IMAGE_TAG
        id: get_sha
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            ACTUAL_SHA="${{ github.event.workflow_run.head_sha }}"
          else
            ACTUAL_SHA="${{ github.sha }}"
          fi
          
          SHORT_SHA=$(echo ${ACTUAL_SHA} | cut -c1-8)
          echo "IMAGE_TAG=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${SHORT_SHA}" >> $GITHUB_ENV

      - name: Check if images exist
        id: check-images
        run: |
          SHORT_SHA="${{ steps.get_sha.outputs.IMAGE_TAG }}"
          
          if docker manifest inspect ashritha07/analytics-reporting-service:${SHORT_SHA} > /dev/null 2>&1; then
            echo "use_sha_tag=true" >> $GITHUB_OUTPUT
            echo "IMAGE_TAG=${SHORT_SHA}" >> $GITHUB_ENV
          else
            echo "use_sha_tag=false" >> $GITHUB_OUTPUT
            echo "IMAGE_TAG=latest" >> $GITHUB_ENV
          fi

      - name: Deploy
        run: |
          cd infra
          docker-compose pull
          docker-compose down
          docker-compose up -d
          sleep 10
          docker-compose ps